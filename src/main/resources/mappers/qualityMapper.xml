<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

	<mapper namespace="com.modernhome.mapper.QualityMapper">

	<!-- Join 결과 매핑 RM은 resultMap -->
	<resultMap id="wijoinRM" type="WijoinVO">
		<result property="work_id" column="work_id"/>
		<result property="pro_id" column="pro_id"/>
		<result property="req_id" column="req_id"/>
		<result property="clt_id" column="clt_id"/>
		<result property="oo_id" column="oo_id"/>
		<result property="line_id" column="line_id"/>
		<result property="emp_id" column="emp_id"/>
		<result property="update_emp_id" column="update_emp_id"/>
		<result property="work_num" column="work_num"/>
		<result property="pro_num" column="pro_num"/>
		<result property="ma_num" column="ma_num"/>
		<result property="oo_num" column="oo_num"/>
		<result property="line_num" column="line_num"/>
		<result property="clt_name" column="clt_name"/>
		<result property="pro_name" column="pro_name"/>
		<result property="pro_unit" column="pro_unit"/>
		<result property="emp_name" column="emp_name"/>
		<result property="line_name" column="line_name"/>
		<result property="ma_num" column="ma_num"/>
		<result property="ma_name" column="ma_name"/>
		<result property="oo_cnt" column="oo_cnt"/>
		<result property="req_cnt" column="req_cnt"/>
		<result property="work_cnt" column="work_cnt"/>
		<result property="work_state" column="work_state"/>
		<result property="reg_date" column="reg_date"/>
		<result property="oo_end_date" column="oo_end_date"/>
		<result property="qc_id" column="qc_id"/>
		<result property="qc_num" column="qc_num"/>
		<result property="qc_yn" column="qc_yn"/>
		<result property="qc_cnt" column="qc_cnt"/>
		<result property="qc_date" column="qc_date"/>
		<result property="repaired" column="repaired"/>
		<result property="prfrm_id" column="prfrm_id"/>
		<result property="prfrm_num" column="prfrm_num"/>
		<result property="ma_id" column="ma_id"/>
		<result property="io_id" column="io_id"/>
		<result property="rec_id" column="rec_id"/>
		<result property="df_cnt" column="df_cnt"/>
		<result property="shp_id" column="shp_id"/>
		<result property="shp_num" column="shp_num"/>
		<result property="shp_cnt" column="shp_cnt"/>
		<result property="fi_type" column="fi_type"/>
	</resultMap>
	<!-- Join 결과 매핑 -->
	
	<!-- 품질검사(완제품) 목록 조회 -->
	<select id="getQualityList" resultMap="wijoinRM">
		SELECT qc.qc_id, wi.work_num, qc.qc_num, l.line_num, l.line_name, p.pro_num, p.pro_name, qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, qc.df_cnt, qc.qc_cnt, wp.prfrm_cnt, qc.qc_yn,
	    CASE
			WHEN qc.update_emp_id IS NULL THEN
				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id)
			ELSE
				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id)
		END AS emp_name
	    FROM quality_checking qc
	    LEFT JOIN work_instr wi ON qc.work_id = wi.work_id 
	    LEFT JOIN line l ON qc.line_id = l.line_id 
	    LEFT JOIN product p ON qc.pro_id = p.pro_id 
	    LEFT JOIN work_prfrm wp ON qc.qc_id = wp.qc_id 
	    LEFT JOIN employee e ON qc.emp_id = e.emp_id
	    WHERE wi.work_id IS NOT NULL
	    LIMIT #{startPage}, #{pageSize}
	</select>
	<!-- 품질검사(완제품) 목록 조회 -->
	
	<!-- 품질검사(완제품) 검색 -->
	<select id="getQualitySearch" resultMap="wijoinRM">
		SELECT qc.qc_id, wi.work_num, qc.qc_num, l.line_num, l.line_name, p.pro_num, p.pro_name, qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, qc.df_cnt, qc.qc_cnt, wp.prfrm_cnt, qc.qc_yn,
	    CASE
			WHEN qc.update_emp_id IS NULL THEN
				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id)
			ELSE
				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id)
		END AS emp_name
	    FROM quality_checking qc
	    LEFT JOIN work_instr wi ON qc.work_id = wi.work_id 
	    LEFT JOIN line l ON qc.line_id = l.line_id 
	    LEFT JOIN product p ON qc.pro_id = p.pro_id 
	    LEFT JOIN work_prfrm wp ON qc.qc_id = wp.qc_id 
	    LEFT JOIN employee e ON qc.emp_id = e.emp_id
		<where>
			<if test="qc_num != ''">
				AND qc_num like CONCAT('%', #{qc_num}, '%')
			</if>
			<if test="startDate != ''">
				AND qc.qc_date &gt;= #{startDate}
			</if>
			<if test="endDate != ''">
				AND #{endDate} &gt;= DATE(qc.qc_date) 
			</if>
			<if test="qc_yn != '전체'">
				AND qc_yn = #{qc_yn}
			</if>
		</where>
		LIMIT #{pageVO.startPage}, #{pageVO.pageSize}
	</select>
	
	<!-- 품질검사(완제품) 검색 -->
	
	<!-- 품질검사(완제품) 수정 -->
	<update id="updateQuality">
		UPDATE quality_checking 
		SET update_emp_id = #{update_emp_id}, qc_cnt = #{qc_cnt}, update_date = now(), qc_yn = #{qc_yn}
		WHERE qc_num = #{qc_num}
	</update>
	<!-- 품질검사(완제품) 수정 -->
	
	
	<!-- 전체 글 수 계산 -->
	<select id="getTotalCntQc" resultType="int">
		SELECT count(qc.qc_id)
		FROM quality_checking qc
		LEFT JOIN work_instr wi ON qc.work_id = wi.work_id 
	    LEFT JOIN line l ON qc.line_id = l.line_id 
	    LEFT JOIN product p ON qc.pro_id = p.pro_id 
	    LEFT JOIN work_prfrm wp ON qc.qc_id = wp.qc_id 
	    LEFT JOIN employee e ON qc.emp_id = e.emp_id
	   	WHERE wi.work_id IS NOT NULL
	</select>
	<!-- 전체 글 수 계산 -->
	
	<!-- 검색 결과 개수 계산 -->
	<select id="getQualitySearchCnt" resultType="int">
		SELECT count(qc.qc_id)
		FROM quality_checking qc
	    LEFT JOIN work_instr wi ON qc.work_id = wi.work_id 
	    LEFT JOIN line l ON qc.line_id = l.line_id 
	    LEFT JOIN product p ON qc.pro_id = p.pro_id 
	    LEFT JOIN work_prfrm wp ON qc.qc_id = wp.qc_id 
	    LEFT JOIN employee e ON qc.emp_id = e.emp_id
		<where>
			<if test="qc_num != ''">
				AND qc_num like CONCAT('%', #{qc_num}, '%')
			</if>
			<if test="startDate != ''">
				AND qc.qc_date &gt;= #{startDate}
			</if>
			<if test="endDate != ''">
				AND #{endDate} &gt;= DATE(qc.qc_date) 
			</if>
			<if test="qc_yn != '전체'">
				AND qc_yn = #{qc_yn}
			</if>
		</where>
	</select>	
	<!-- 검색 결과 개수 계산 -->
	
	
	<!-- 품질검사(자재) 목록 조회 -->
	<select id="getMaterialQualityList" resultMap="wijoinRM">
		SELECT qc.qc_id, rec.rec_num, qc.qc_num, ma.ma_num , ma.ma_name , qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, qc.df_cnt, qc.qc_cnt, rec.rec_cnt, qc.qc_yn,
		CASE
			WHEN qc.update_emp_id IS NULL THEN
				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id)
			ELSE
				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id)
		END AS emp_name
		FROM quality_checking qc
		LEFT JOIN employee e ON qc.emp_id = e.emp_id 
		LEFT JOIN receive rec ON qc.rec_id = rec.rec_id
		LEFT JOIN material ma ON qc.ma_id = ma.ma_id
		WHERE rec.rec_id IS NOT NULL
		LIMIT #{startPage}, #{pageSize}
	</select>
	<!-- 품질검사(자재) 목록 조회 -->
	
	<!-- 품질검사(자재) 검색 -->
	<select id="getMaterialQualitySearch" resultMap="wijoinRM">
		SELECT qc.qc_id, rec.rec_num, qc.qc_num, ma.ma_num , ma.ma_name , qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, qc.df_cnt, qc.qc_cnt, rec.rec_cnt, qc.qc_yn,
		CASE
			WHEN qc.update_emp_id IS NULL THEN
				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id)
			ELSE
				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id)
		END AS emp_name
		FROM quality_checking qc
		LEFT JOIN employee e ON qc.emp_id = e.emp_id 
		LEFT JOIN receive rec ON qc.rec_id = rec.rec_id
		LEFT JOIN material ma ON qc.ma_id = ma.ma_id
		LIMIT #{pageVO.startPage}, #{pageVO.pageSize}
		<where>
			<if test="qc_num != ''">
				AND qc_num like CONCAT('%', #{qc_num}, '%')
			</if>
			<if test="startDate != ''">
				AND qc.qc_date &gt;= #{startDate}
			</if>
			<if test="endDate != ''">
				AND #{endDate} &gt;= DATE(qc.qc_date) 
			</if>
			<if test="qc_yn != '전체'">
				AND qc_yn = #{qc_yn}
			</if>
		</where>
	</select>
	
	<!-- 품질검사(자재) 검색 -->
	
	<!-- 품질검사(자재) 수정 -->
	<update id="updateMaterialQuality">
		UPDATE quality_checking 
		SET update_emp_id = #{update_emp_id}, qc_cnt = #{qc_cnt}, update_date = now(), qc_yn = #{qc_yn}
		WHERE qc_num = #{qc_num}
	</update>
	<!-- 품질검사(자재) 수정 -->
	
	<!-- 전체 글 수 계산(자재) -->
	<select id="getTotalCntMqc" resultType="int">
		SELECT count(qc.qc_id)
		FROM quality_checking qc
		LEFT JOIN employee e ON qc.emp_id = e.emp_id 
		LEFT JOIN receive rec ON qc.rec_id = rec.rec_id
		LEFT JOIN material ma ON qc.ma_id = ma.ma_id
		WHERE rec.rec_id IS NOT NULL
	</select>
	<!-- 전체 글 수 계산(자재) -->
	
	<!-- 검색 결과 개수 계산(자재) -->
	<select id="getMateriqlQualitySearchCnt" resultType="int">
		SELECT count(qc.qc_id)
		FROM quality_checking qc
		LEFT JOIN employee e ON qc.emp_id = e.emp_id 
		LEFT JOIN receive rec ON qc.rec_id = rec.rec_id
		LEFT JOIN material ma ON qc.ma_id = ma.ma_id
		<where>
			<if test="qc_num != ''">
				AND qc_num like CONCAT('%', #{qc_num}, '%')
			</if>
			<if test="startDate != ''">
				AND qc.qc_date &gt;= #{startDate}
			</if>
			<if test="endDate != ''">
				AND #{endDate} &gt;= DATE(qc.qc_date) 
			</if>
			<if test="qc_yn != '전체'">
				AND qc_yn = #{qc_yn}
			</if>
		</where>
	</select>
	<!-- 검색 결과 개수 계산(자재) -->
	
	
	
	<insert id="addQC" parameterType="WijoinVO">
        <selectKey keyProperty="qc_id,qc_num" resultType="WijoinVO" order="BEFORE">
            SELECT ifnull(MAX(qc_id), 0) + 1 AS qc_id, concat('QC', lpad(ifnull(max(qc_id), 0) + 1, 4, 0)) AS qc_num 
            FROM quality_checking
        </selectKey>
			INSERT INTO quality_checking (qc_id, qc_num, rec_id, ma_id, qc_yn, qc_cnt, emp_id, fi_type) 
	        SELECT #{qc_id}, #{qc_num}, #{rec_id}, #{ma_id}, '대기', 0, #{emp_id}, '자재'
	</insert>
	
	<!-- 불량개수가 0이면 입고상태 변경 -->
	<update id="modifyRec" parameterType="WijoinVO">
		UPDATE receive SET rec_in_state = '검사완료'
	  	WHERE rec_id = #{rec_id} AND df_cnt = 0
	</update>
	<!-- 불량개수가 0이면 입고상태 변경 -->
	
	<!-- 출고 검사 목록 출력 -->
<!-- 	<select id="getFIList" resultMap="wijoinRM"> -->
<!-- 		SELECT qc.qc_id, shi.shp_num, pro.pro_num, pro.pro_name, shi.shp_cnt, qc.qc_cnt, qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, -->
<!-- 		ma.mr_num, ma.ma_num, ma.ma_name, ma.mr_cnt, qc.fi_type, -->
<!-- 	    CASE -->
<!-- 			WHEN qc.update_emp_id IS NULL THEN -->
<!-- 				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id) -->
<!-- 			ELSE -->
<!-- 				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id) -->
<!-- 		END AS emp_name -->
<!-- 	    FROM quality_checking qc -->
<!-- 		LEFT JOIN shipment shi ON qc.qc_id = shi.qc_id -->
<!-- 		LEFT JOIN product pro ON pro.pro_id = shi.pro_id -->
<!-- 		LEFT JOIN material_release mr ON qc.mr_id = mr.mr_id -->
<!-- 		LEFT JOIN material m ON m.ma_id = mr.ma_id -->
<!-- 		LEFT JOIN employee emp ON emp.emp_id = qc.emp_id -->
		
<!-- 	</select> -->
	<!-- 출고 검사 목록 출력 -->
	
		<!-- 출고 검사 목록 출력 -->
<!-- 	<select id="getFISearch" resultMap="wijoinRM"> -->
<!-- 		SELECT qc.qc_id, shi.shp_num, pro.pro_num, pro.pro_name, shi.shp_cnt, qc.qc_cnt, qc.emp_id, qc.update_emp_id, qc.qc_date, qc.update_date, -->
<!-- 		ma.mr_num, ma.ma_num, ma.ma_name, ma.mr_cnt, qc.fi_type, -->
<!-- 	    CASE -->
<!-- 			WHEN qc.update_emp_id IS NULL THEN -->
<!-- 				(SELECT emp_name FROM employee WHERE emp_id = qc.emp_id) -->
<!-- 			ELSE -->
<!-- 				(SELECT emp_name FROM employee WHERE emp_id = qc.update_emp_id) -->
<!-- 		END AS emp_name -->
<!-- 	    FROM quality_checking qc -->
<!-- 		LEFT JOIN shipment shi ON qc.qc_id = shi.qc_id -->
<!-- 		LEFT JOIN product pro ON pro.pro_id = shi.pro_id -->
<!-- 		LEFT JOIN material_release mr ON qc.mr_id = mr.mr_id -->
<!-- 		LEFT JOIN material m ON material.ma_id = mr.ma_id -->
<!-- 		LEFT JOIN employee emp ON emp.emp_id = qc.emp_id -->
<!-- 		<where> -->
<!-- 			<if test="fi_type != ''"> -->
<!-- 				AND fi_type = #{fi_type} -->
<!-- 			</if> -->
<!-- 			<if test="nameSearch != ''"> -->
<!-- 				<if test="fi_type == 'all'"> -->
<!-- 					AND (pro_name like CONCAT('%', #{nameSearch}, '%') OR ma_name like CONCAT('%', #{nameSearch}, '%'))  -->
<!-- 				</if> -->
<!-- 				<if test="fi_type == '완제품'"> -->
<!-- 					AND pro_name like CONCAT('%', #{nameSearch}, '%')  -->
<!-- 				</if> -->
<!-- 				<if test="fi_type == '자재'"> -->
<!-- 					AND ma_name like CONCAT('%', #{nameSearch}, '%')  -->
<!-- 				</if> -->
<!-- 			</if> -->
<!-- 			<if test="startDate != ''"> -->
<!-- 				AND qc.qc_date &gt;= #{startDate} -->
<!-- 			</if> -->
<!-- 			<if test="endDate != ''"> -->
<!-- 				AND #{endDate} &gt;= DATE(qc.qc_date)  -->
<!-- 			</if> -->
<!-- 		</where> -->
<!-- 	</select> -->
	<!-- 출고 검사 목록 출력 -->
	
	
</mapper>